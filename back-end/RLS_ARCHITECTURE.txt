🔒 ROW LEVEL SECURITY (RLS) - ARCHITETTURA MULTI-TENANT
================================================================

┌─────────────────────────────────────────────────────────────────┐
│                        FRONTEND (React)                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Login Form    │  │  Activity List  │  │   Admin Panel   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP/API Calls
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      BACKEND (Flask)                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  Auth Routes    │  │  Activity Routes│  │  Admin Routes   │ │
│  │  @token_required│  │  @rls_required  │  │  @admin_rls_req │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                │                               │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              RLS MANAGER                                   │ │
│  │  • set_user_context()                                     │ │
│  │  • get_current_context()                                  │ │
│  │  • clear_context()                                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ SQL Queries
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DATABASE (SQLite)                           │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    RLS TABLES                              │ │
│  │  ┌─────────────────┐  ┌─────────────────┐                  │ │
│  │  │  rls_context    │  │  rls_policies   │                  │ │
│  │  │  • current_user │  │  • table_name   │                  │ │
│  │  │  • session_id   │  │  • policy_type  │                  │ │
│  │  │  • created_at   │  │  • expression   │                  │ │
│  │  └─────────────────┘  └─────────────────┘                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  RLS TRIGGERS                              │ │
│  │  ┌─────────────────┐  ┌─────────────────┐                  │ │
│  │  │ activities_*    │  │ users_*         │                  │ │
│  │  │ • SELECT        │  │ • SELECT        │                  │ │
│  │  │ • INSERT        │  │ • UPDATE        │                  │ │
│  │  │ • UPDATE        │  │                 │                  │ │
│  │  │ • DELETE        │  │                 │                  │ │
│  │  └─────────────────┘  └─────────────────┘                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                PROTECTED VIEWS                             │ │
│  │  ┌─────────────────┐  ┌─────────────────┐                  │ │
│  │  │protected_       │  │protected_       │                  │ │
│  │  │activities       │  │users            │                  │ │
│  │  │• Auto-filtered  │  │• Auto-filtered  │                  │ │
│  │  │• user_id check  │  │• user_id check  │                  │ │
│  │  └─────────────────┘  └─────────────────┘                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  USER DATA TABLES                          │ │
│  │  ┌─────────────────┐  ┌─────────────────┐                  │ │
│  │  │     users       │  │   activities    │                  │ │
│  │  │ • id (PK)       │  │ • id (PK)       │                  │ │
│  │  │ • username      │  │ • title         │                  │ │
│  │  │ • email         │  │ • description   │                  │ │
│  │  │ • password_hash │  │ • date          │                  │ │
│  │  │ • is_admin      │  │ • user_id (FK)  │                  │ │
│  │  │ • is_active     │  │ • status        │                  │ │
│  │  └─────────────────┘  │ • priority      │                  │ │
│  │                       └─────────────────┘                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘

🔄 FLUSSO DI SICUREZZA RLS
==========================

1. LOGIN UTENTE
   ┌─────────────┐
   │ User Login  │ ──► JWT Token
   └─────────────┘

2. RICHIESTA API
   ┌─────────────┐
   │ API Request │ ──► @token_required ──► @rls_required
   └─────────────┘

3. IMPOSTAZIONE CONTESTO
   ┌─────────────┐
   │ RLS Manager │ ──► set_user_context(user_id)
   └─────────────┘

4. QUERY DATABASE
   ┌─────────────┐
   │ SQL Query   │ ──► RLS Triggers ──► Policy Check
   └─────────────┘

5. RISULTATO FILTRATO
   ┌─────────────┐
   │ Filtered    │ ──► Only User's Data
   │ Results     │
   └─────────────┘

🛡️ POLICY DI SICUREZZA
======================

TABELLA ACTIVITIES:
┌─────────────────────────────────────────────────────────────────┐
│ SELECT:  user_id = current_user_id                             │
│ INSERT:  user_id = current_user_id                             │
│ UPDATE:  user_id = current_user_id                             │
│ DELETE:  user_id = current_user_id                             │
└─────────────────────────────────────────────────────────────────┘

TABELLA USERS:
┌─────────────────────────────────────────────────────────────────┐
│ SELECT:  id = current_user_id OR is_admin = 1                  │
│ UPDATE:  id = current_user_id                                  │
└─────────────────────────────────────────────────────────────────┘

🔍 TRIGGER DI SICUREZZA
=======================

BEFORE SELECT ON activities:
┌─────────────────────────────────────────────────────────────────┐
│ IF user_id != current_user_id THEN                             │
│   RAISE(ABORT, 'Access denied: RLS violation')                 │
│ END IF                                                          │
└─────────────────────────────────────────────────────────────────┘

BEFORE INSERT ON activities:
┌─────────────────────────────────────────────────────────────────┐
│ IF NEW.user_id != current_user_id THEN                         │
│   RAISE(ABORT, 'Access denied: RLS violation')                 │
│ END IF                                                          │
└─────────────────────────────────────────────────────────────────┘

BEFORE UPDATE ON activities:
┌─────────────────────────────────────────────────────────────────┐
│ IF OLD.user_id != current_user_id OR                           │
│    NEW.user_id != current_user_id THEN                         │
│   RAISE(ABORT, 'Access denied: RLS violation')                 │
│ END IF                                                          │
└─────────────────────────────────────────────────────────────────┘

BEFORE DELETE ON activities:
┌─────────────────────────────────────────────────────────────────┐
│ IF OLD.user_id != current_user_id THEN                         │
│   RAISE(ABORT, 'Access denied: RLS violation')                 │
│ END IF                                                          │
└─────────────────────────────────────────────────────────────────┘

📊 VISTE PROTETTE
=================

protected_activities:
┌─────────────────────────────────────────────────────────────────┐
│ SELECT * FROM activities                                        │
│ WHERE user_id = (SELECT current_user_id FROM rls_context       │
│                  WHERE id = 1)                                 │
└─────────────────────────────────────────────────────────────────┘

protected_users:
┌─────────────────────────────────────────────────────────────────┐
│ SELECT * FROM users                                             │
│ WHERE id = (SELECT current_user_id FROM rls_context            │
│              WHERE id = 1)                                     │
│ OR (SELECT is_admin FROM users                                 │
│     WHERE id = (SELECT current_user_id FROM rls_context        │
│                  WHERE id = 1)) = 1                            │
└─────────────────────────────────────────────────────────────────┘

🎯 VANTAGGI RLS
===============

✅ SICUREZZA:
   • Isolamento garantito a livello database
   • Impossibile bypassare le policy
   • Protezione contro errori di programmazione

✅ PERFORMANCE:
   • Filtri automatici senza overhead applicativo
   • Indici ottimizzati per query RLS
   • Scalabilità per migliaia di utenti

✅ MANUTENIBILITÀ:
   • Policy centralizzate e configurabili
   • Codice più pulito (meno filtri manuali)
   • Testing e audit integrati

✅ COMPATIBILITÀ:
   • Funziona con SQLite 3.7.0+
   • Compatibile con ORM esistenti
   • Facile migrazione da filtri applicativi

🔧 CONFIGURAZIONE
=================

1. SETUP INIZIALE:
   python rls_setup.py

2. INTEGRAZIONE:
   @rls_required decorator

3. TESTING:
   python test_rls.py

4. MONITORAGGIO:
   GET /api/rls/stats

================================================================
